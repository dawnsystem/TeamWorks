<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reparar TeamWorks</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
        }
        h1 {
            color: #333;
            margin-bottom: 1rem;
        }
        .status {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            font-weight: 600;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            font-weight: 600;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .steps {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }
        .steps li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        .steps li:before {
            content: "‚úì ";
            color: #28a745;
            font-weight: bold;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Reparar TeamWorks</h1>
        
        <div id="status" class="status info">
            Preparado para reparar la configuraci√≥n...
        </div>

        <div id="results"></div>

        <button id="fixBtn" onclick="fixConfiguration()">
            üöÄ Reparar Ahora
        </button>

        <button id="openBtn" onclick="openApp()" style="display:none; background: #28a745;">
            ‚úÖ Abrir TeamWorks
        button>
    </div>

    <script>
        async function testBackend() {
            try {
                const response = await fetch('http://localhost:3000/health', {
                    method: 'GET',
                    mode: 'cors'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function fixConfiguration() {
            const btn = document.getElementById('fixBtn');
            const status = document.getElementById('status');
            const results = document.getElementById('results');
            const openBtn = document.getElementById('openBtn');

            btn.disabled = true;
            status.className = 'status info';
            status.textContent = 'üîÑ Reparando configuraci√≥n...';

            const steps = [];

            // Paso 1: Verificar backend
            status.textContent = '1/4 Verificando backend...';
            const backendOk = await testBackend();
            if (backendOk) {
                steps.push('Backend accesible ‚úì');
            } else {
                steps.push('‚ö†Ô∏è Backend no responde - Aseg√∫rate de iniciarlo');
            }

            // Paso 2: Limpiar localStorage
            status.textContent = '2/4 Limpiando configuraci√≥n antigua...';
            localStorage.clear();
            sessionStorage.clear();
            steps.push('LocalStorage limpiado ‚úì');

            // Paso 3: Establecer configuraci√≥n correcta
            status.textContent = '3/4 Estableciendo configuraci√≥n correcta...';
            localStorage.setItem('settings-storage', JSON.stringify({
                state: {
                    apiUrl: 'http://localhost:3000/api',
                    geminiApiKey: '',
                    groqApiKey: '',
                    theme: {
                        primaryColor: '#dc2626',
                        accentColor: '#ec4899',
                        logoUrl: ''
                    }
                },
                version: 0
            }));
            steps.push('Configuraci√≥n establecida ‚úì');

            // Paso 4: Verificar
            status.textContent = '4/4 Verificando...';
            const config = JSON.parse(localStorage.getItem('settings-storage'));
            if (config && config.state && config.state.apiUrl === 'http://localhost:3000/api') {
                steps.push('Verificaci√≥n exitosa ‚úì');
            } else {
                steps.push('‚ö†Ô∏è Error en verificaci√≥n');
            }

            // Mostrar resultados
            results.innerHTML = '<ul class="steps">' + 
                steps.map(step => '<li>' + step + '</li>').join('') + 
                '</ul>';

            if (backendOk) {
                status.className = 'status success';
                status.textContent = '‚úÖ ¬°Reparaci√≥n completada! Puedes abrir TeamWorks ahora.';
                openBtn.style.display = 'block';
            } else {
                status.className = 'status warning';
                status.textContent = '‚ö†Ô∏è Configuraci√≥n reparada, pero el backend no responde. In√≠cialo primero.';
                results.innerHTML += '<div style="margin-top:1rem; padding:1rem; background:#fff3cd; border-radius:0.5rem;">' +
                    '<strong>Para iniciar el backend:</strong><br>' +
                    '1. Abre PowerShell en el directorio del proyecto<br>' +
                    '2. Ejecuta: <code>cd server && npm run dev</code><br>' +
                    '3. Luego recarga esta p√°gina y haz click en "Reparar Ahora" de nuevo' +
                    '</div>';
            }

            btn.disabled = false;
            btn.textContent = 'üîÑ Reparar de Nuevo';
        }

        function openApp() {
            window.location.href = 'http://localhost:5173';
        }

        // Auto-ejecutar al cargar
        window.addEventListener('load', () => {
            setTimeout(() => {
                const autoFix = confirm('¬øQuieres reparar la configuraci√≥n autom√°ticamente?');
                if (autoFix) {
                    fixConfiguration();
                }
            }, 500);
        });
    </script>
</body>
</html>
